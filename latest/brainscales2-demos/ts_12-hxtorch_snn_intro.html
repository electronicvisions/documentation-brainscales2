<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>hxtorch.snn Introduction &mdash; BrainScaleS-2 Documentation 0.0.1 documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/visions.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Partitioning of Feedforward SNNs" href="ts_13-network_partitioning.html" />
    <link rel="prev" title="BrainScaleS-2 on-chip plasticity experiment" href="ts_11-plasticity_homeostasis.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            BrainScaleS-2 Documentation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Demos &amp; Examples</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="tutorial.html">Demos and Examples</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="ts_00-single_neuron.html">BrainScaleS-2 single neuron experiments</a></li>
<li class="toctree-l3"><a class="reference internal" href="ts_01-superspike.html">Learning with the SuperSpike rule</a></li>
<li class="toctree-l3"><a class="reference internal" href="ts_02-plasticity_rate_coding.html">BrainScaleS-2 on-chip plasticity experiment</a></li>
<li class="toctree-l3"><a class="reference internal" href="ts_03-multicompartment.html">Multicompartmental Neurons</a></li>
<li class="toctree-l3"><a class="reference internal" href="ts_04-mc_genetic_algorithms.html">How to use Genetic Algorithms to automatically parameterize BrainScaleS-2</a></li>
<li class="toctree-l3"><a class="reference internal" href="ts_05-yin_yang.html">Training an SNN on BrainScaleS-2 with PyTorch</a></li>
<li class="toctree-l3"><a class="reference internal" href="ts_06-dynamic_range.html">Exploring the dynamic range</a></li>
<li class="toctree-l3"><a class="reference internal" href="ts_07-pong.html">Pong</a></li>
<li class="toctree-l3"><a class="reference internal" href="ts_08-adex_complex_dynamics.html">Complex Neuron Dynamics with a Silicon Adaptive Exponential Integrate-and-Fire Neuron</a></li>
<li class="toctree-l3"><a class="reference internal" href="ts_09-inside_realtime_hook.html">Demonstration of inside realtime hook</a></li>
<li class="toctree-l3"><a class="reference internal" href="ts_10-multiple_configs.html">Demonstration of multiple chip-reconfigurations during an experiment</a></li>
<li class="toctree-l3"><a class="reference internal" href="ts_11-plasticity_homeostasis.html">BrainScaleS-2 on-chip plasticity experiment</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">hxtorch.snn Introduction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#emulate-a-network-on-bss-2">Emulate a network on BSS-2</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="ts_13-network_partitioning.html">Partitioning of Feedforward SNNs</a></li>
<li class="toctree-l3"><a class="reference internal" href="tp_00-introduction.html">Introduction to matrix multiplication</a></li>
<li class="toctree-l3"><a class="reference internal" href="tp_01-properties.html">Exploring the analog MAC operation</a></li>
<li class="toctree-l3"><a class="reference internal" href="tp_02-yin_yang.html">Train DNNs on BrainScaleS-2</a></li>
<li class="toctree-l3"><a class="reference internal" href="nmpi_00-non_interactive_queue_runner.html">Introduction to the non-interactive queue runner</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#executing-the-notebooks">Executing the Notebooks</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#shared-hardware-resources">Shared Hardware Resources</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial.html#final-test-hardware-execution">Final test: Hardware Execution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="girlsday.html">Wie verarbeitet unser Gehirn Informationen?</a></li>
<li class="toctree-l2"><a class="reference internal" href="fortgeschrittenen_praktikum.html">Welcome to the Advanced Physics Lab for Physicists by the Electronic Vision(s) Group</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../software_components.html">Software Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apis.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BrainScaleS-2 Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Welcome to the BrainScaleS-2 Demos &amp; Examples!</a></li>
          <li class="breadcrumb-item"><a href="tutorial.html">Welcome to the BrainScaleS-2 Tutorial</a></li>
      <li class="breadcrumb-item active">hxtorch.snn Introduction</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/brainscales2-demos/ts_12-hxtorch_snn_intro.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="hxtorch-snn-introduction">
<h1>hxtorch.snn Introduction<a class="headerlink" href="#hxtorch-snn-introduction" title="Permalink to this headline"></a></h1>
<p>In this tutorial we will explore the <code class="docutils literal notranslate"><span class="pre">hxtorch.snn</span></code> framework used to train networks of spiking neurons on the BrainScaleS-2 platform in a machine-learning-inspired fashion.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">from</span> <span class="nn">_static.tutorial.hxsnn_intro_plots</span> <span class="kn">import</span> <span class="n">plot_training</span><span class="p">,</span> <span class="n">plot_compare_traces</span><span class="p">,</span> <span class="n">plot_mock</span><span class="p">,</span> <span class="n">plot_scaled_trace</span><span class="p">,</span> <span class="n">plot_targets</span>
<span class="kn">from</span> <span class="nn">_static.common.helpers</span> <span class="kn">import</span> <span class="n">setup_hardware_client</span><span class="p">,</span> <span class="n">save_nightly_calibration</span>
<span class="n">setup_hardware_client</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">hxtorch</span>
<span class="kn">import</span> <span class="nn">hxtorch.snn</span> <span class="k">as</span> <span class="nn">hxsnn</span>
</pre></div>
</div>
<div class="section" id="emulate-a-network-on-bss-2">
<h2>Emulate a network on BSS-2<a class="headerlink" href="#emulate-a-network-on-bss-2" title="Permalink to this headline"></a></h2>
<p>To start, we create a small network with a single spiking leak-integrate and fire (LIF) <code class="docutils literal notranslate"><span class="pre">Neuron</span></code>, receiving inputs through a linear <code class="docutils literal notranslate"><span class="pre">Synapse</span></code> layer.
Network layers in <code class="docutils literal notranslate"><span class="pre">hxtorch</span></code> are derived from a parent class <code class="docutils literal notranslate"><span class="pre">HXModule</span></code> (similar to <code class="docutils literal notranslate"><span class="pre">torch.nn.Module</span></code> in PyTorch), requiring an instance of <code class="docutils literal notranslate"><span class="pre">Experiment</span></code> which keeps track of all network layers to be run within the same experiment on BSS-2.
While <code class="docutils literal notranslate"><span class="pre">Neuron</span></code>s can be parameterized individually, we keep the default parameters for now.</p>
<p>Next we create some input spikes and emulate the network.
The membrane potential of the LIF is measured using the columnar ADC (CADC) and the membrane (MADC).
While the first allows sampling all neuron potentials on the chip in parallel, the latter can only sample two neurons at the benefit of having a higher temporal resolution.
The units are CADC / MADC Values, which in principle are translatable to mV (which will be implemented in the future).
When modules are called to infere the networks topology, they return <code class="docutils literal notranslate"><span class="pre">Handles</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">g</span></code>, <code class="docutils literal notranslate"><span class="pre">z</span></code>) which act as promises to future hardware data which get filled after the hardware experiment is run.
Note that in <code class="docutils literal notranslate"><span class="pre">hxtorch</span></code> the returned hardware data is mapped to a dense time grid of shape <code class="docutils literal notranslate"><span class="pre">(batch_size,</span> <span class="pre">time_steps,</span> <span class="pre">population_size)</span></code> of resolution <code class="docutils literal notranslate"><span class="pre">dt</span></code>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">save_nightly_calibration</span><span class="p">(</span><span class="s1">&#39;spiking_calix-native.pkl&#39;</span><span class="p">)</span>

<span class="n">hxtorch</span><span class="o">.</span><span class="n">init_hardware</span><span class="p">()</span>

<span class="c1"># Experiment</span>
<span class="n">exp</span> <span class="o">=</span> <span class="n">hxsnn</span><span class="o">.</span><span class="n">Experiment</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
<span class="c1"># To avoid time consuming implict calibration we load a prepared calibration</span>
<span class="n">exp</span><span class="o">.</span><span class="n">default_execution_instance</span><span class="o">.</span><span class="n">load_calib</span><span class="p">(</span><span class="s2">&quot;spiking_calix-native.pkl&quot;</span><span class="p">)</span>

<span class="c1"># Modules</span>
<span class="n">syn</span> <span class="o">=</span> <span class="n">hxsnn</span><span class="o">.</span><span class="n">Synapse</span><span class="p">(</span>
    <span class="n">in_features</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">out_features</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">experiment</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
<span class="n">lif</span> <span class="o">=</span> <span class="n">hxsnn</span><span class="o">.</span><span class="n">Neuron</span><span class="p">(</span>
    <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">experiment</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span>
    <span class="n">enable_cadc_recording</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">enable_madc_recording</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">enable_spike_recording</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">record_neuron_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">cadc_time_shift</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Weights on hardware are between -63 to 63</span>
<span class="n">syn</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span>

<span class="c1"># Some random input spikes</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">inputs</span><span class="p">[[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># in dt</span>

<span class="c1"># Forward</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">syn</span><span class="p">(</span><span class="n">hxsnn</span><span class="o">.</span><span class="n">NeuronHandle</span><span class="p">(</span><span class="n">inputs</span><span class="p">))</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">lif</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">spikes</span><span class="p">,</span> <span class="n">z</span><span class="o">.</span><span class="n">membrane_cadc</span><span class="p">)</span>

<span class="n">hxsnn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>  <span class="c1"># dt</span>

<span class="nb">print</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">spikes</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">z</span><span class="o">.</span><span class="n">membrane_cadc</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Display</span>
<span class="n">plot_compare_traces</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

<span class="n">hxtorch</span><span class="o">.</span><span class="n">release_hardware</span><span class="p">()</span>
</pre></div>
</div>
<a class="solution reference internal image-reference" href="../_images/hxsnn_intro_cadc_vs_madc.png"><img alt="../_images/hxsnn_intro_cadc_vs_madc.png" class="solution align-center" src="../_images/hxsnn_intro_cadc_vs_madc.png" style="width: 90%;" /></a>
<p>Great, we have now seen how easily spiking neural networks are emulated on BSS-2.
In order to train them, each layer instance of <code class="docutils literal notranslate"><span class="pre">HXModule</span></code> has a PyTorch-differentiable numerical representation defined in a member function <code class="docutils literal notranslate"><span class="pre">forward_func</span></code>.
This function allows backpropagating gradients but also to simulate networks.
Simulation is enabled by setting <code class="docutils literal notranslate"><span class="pre">mock=True</span></code> in the <code class="docutils literal notranslate"><span class="pre">Experiment</span></code> instance:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Experiment</span>
<span class="n">exp</span> <span class="o">=</span> <span class="n">hxsnn</span><span class="o">.</span><span class="n">Experiment</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">mock</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Modules</span>
<span class="n">syn</span> <span class="o">=</span> <span class="n">hxsnn</span><span class="o">.</span><span class="n">Synapse</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
<span class="n">syn</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>  <span class="c1"># weights are between -63 to 63</span>
<span class="n">lif</span> <span class="o">=</span> <span class="n">hxsnn</span><span class="o">.</span><span class="n">Neuron</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>

<span class="c1"># Forward</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">syn</span><span class="p">(</span><span class="n">hxsnn</span><span class="o">.</span><span class="n">NeuronHandle</span><span class="p">(</span><span class="n">inputs</span><span class="p">))</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">lif</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

<span class="c1"># Simulate</span>
<span class="n">hxsnn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>  <span class="c1"># dt</span>

<span class="c1"># Display</span>
<span class="n">plot_mock</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre></div>
</div>
<a class="solution reference internal image-reference" href="../_images/hxsnn_intro_mock_mode.png"><img alt="../_images/hxsnn_intro_mock_mode.png" class="solution align-center" src="../_images/hxsnn_intro_mock_mode.png" style="width: 90%;" /></a>
<p>Since the dynamics of the numerics is used to compute gradients it is important to align them to the dynamics of the neurons on hardware.
If you compare the y-axes between the first and the second plot you see, that this is not the case here.
There are two scalings which can be used to align the dynamics.
First there is the <code class="docutils literal notranslate"><span class="pre">trace_scaling</span></code> which is applied to the measured membrane trace, this allows to scale the hardware values into the expected simulated range.
Additionally, the measured traces can be offset either by setting <code class="docutils literal notranslate"><span class="pre">shift_to_fist=True</span></code> which uses the first measured value as baseline, or setting a <code class="docutils literal notranslate"><span class="pre">trace_offset</span></code> specifically.
The second scaling is the scaling between the weights used in the sofware model and the weights used on hardware, since the “strength” of the weights on BSS-2 depend on the calibration.</p>
<p>First we want to align the membrane ranges.
For this, we assume <code class="docutils literal notranslate"><span class="pre">leak=0</span></code>, <code class="docutils literal notranslate"><span class="pre">reset=0</span></code> and <code class="docutils literal notranslate"><span class="pre">threshold=1</span></code> for the LIF neuron in the numerics.
<code class="docutils literal notranslate"><span class="pre">Neuron</span></code>s can be parameterized with different values for the <code class="docutils literal notranslate"><span class="pre">model</span></code> in software which is used for gradient computation and the neuron on <code class="docutils literal notranslate"><span class="pre">hardware</span></code> using a <code class="docutils literal notranslate"><span class="pre">MixedHXModelParameter</span></code>:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hxtorch.snn.transforms.weight_transforms</span> <span class="kn">import</span> <span class="n">linear_saturating</span>

<span class="n">hxtorch</span><span class="o">.</span><span class="n">init_hardware</span><span class="p">()</span>

<span class="c1"># Model parameters</span>
<span class="n">model_threshold</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">model_leak</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="n">model_reset</span> <span class="o">=</span> <span class="mf">0.</span>

<span class="c1"># BSS-2 parameters</span>
<span class="n">bss2_threshold</span> <span class="o">=</span> <span class="mi">125</span>
<span class="n">bss2_leak</span> <span class="o">=</span> <span class="mi">80</span>
<span class="n">bss2_reset</span> <span class="o">=</span> <span class="mi">80</span>

<span class="c1"># Post-processing</span>
<span class="c1"># These values are measured in the following</span>
<span class="n">trace_scale</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">trace_offset</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="n">weight_scale</span> <span class="o">=</span> <span class="mf">1.</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">mock</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">weight_scale</span><span class="o">=</span><span class="mf">63.</span><span class="p">,</span> <span class="n">trace_offset</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">trace_scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">n_runs</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
    <span class="n">traces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_runs</span><span class="p">):</span>
        <span class="c1"># Experiment</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">hxsnn</span><span class="o">.</span><span class="n">Experiment</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">mock</span><span class="o">=</span><span class="n">mock</span><span class="p">)</span>
        <span class="n">exp</span><span class="o">.</span><span class="n">default_execution_instance</span><span class="o">.</span><span class="n">load_calib</span><span class="p">(</span><span class="s2">&quot;spiking_calix-native.pkl&quot;</span><span class="p">)</span>

        <span class="c1"># Modules</span>
        <span class="n">syn</span> <span class="o">=</span> <span class="n">hxsnn</span><span class="o">.</span><span class="n">Synapse</span><span class="p">(</span>
            <span class="n">in_features</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">out_features</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">experiment</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">linear_saturating</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">weight_scale</span><span class="p">))</span>
        <span class="n">lif</span> <span class="o">=</span> <span class="n">hxsnn</span><span class="o">.</span><span class="n">Neuron</span><span class="p">(</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">experiment</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span>
            <span class="n">leak</span><span class="o">=</span><span class="n">hxsnn</span><span class="o">.</span><span class="n">MixedHXModelParameter</span><span class="p">(</span><span class="n">model_leak</span><span class="p">,</span> <span class="n">bss2_leak</span><span class="p">),</span>
            <span class="n">reset</span><span class="o">=</span><span class="n">hxsnn</span><span class="o">.</span><span class="n">MixedHXModelParameter</span><span class="p">(</span><span class="n">model_reset</span><span class="p">,</span> <span class="n">bss2_reset</span><span class="p">),</span>
            <span class="n">threshold</span><span class="o">=</span><span class="n">hxsnn</span><span class="o">.</span><span class="n">MixedHXModelParameter</span><span class="p">(</span><span class="n">model_threshold</span><span class="p">,</span> <span class="n">bss2_threshold</span><span class="p">),</span>
            <span class="n">cadc_time_shift</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">trace_offset</span><span class="o">=</span><span class="n">trace_offset</span><span class="p">,</span>
            <span class="n">trace_scale</span><span class="o">=</span><span class="n">trace_scale</span><span class="p">)</span>
        <span class="n">syn</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>
        <span class="c1"># Forward</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">syn</span><span class="p">(</span><span class="n">hxsnn</span><span class="o">.</span><span class="n">NeuronHandle</span><span class="p">(</span><span class="n">inputs</span><span class="p">))</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">lif</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="n">hxsnn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>  <span class="c1"># dt</span>
        <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">membrane_cadc</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">traces</span>


<span class="c1"># Measure baseline</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">traces</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<span class="n">baselines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">traces</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CADC membrane baseline: &quot;</span><span class="p">,</span> <span class="n">baselines</span><span class="p">)</span>


<span class="c1"># Measure hardware threshold</span>
<span class="c1"># We send a lot input spikes to excite the membrane potential towards the threshold potential</span>
<span class="c1"># This will allow us to measure the real threshold value on hardware</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">traces</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">trace_offset</span><span class="o">=</span><span class="n">baselines</span><span class="p">)</span>
<span class="n">bss2_threshold_real</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">traces</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">trace_scale</span> <span class="o">=</span> <span class="n">model_threshold</span> <span class="o">/</span> <span class="n">bss2_threshold_real</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Leak - Threshold on BSS-2: &quot;</span><span class="p">,</span> <span class="n">bss2_threshold_real</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trace scaling: &quot;</span><span class="p">,</span> <span class="n">trace_scale</span><span class="p">)</span>


<span class="c1"># Next we tune the weight_scaling such that the PSP in the software model and on hardware look the same.</span>
<span class="c1"># For this, we send exactly one input to compare the PSPs</span>
<span class="n">weight_scaling</span> <span class="o">=</span> <span class="mf">55.</span>

<span class="n">inputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">inputs</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">mock_trace</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">mock</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_runs</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">bss2_traces</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">trace_offset</span><span class="o">=</span><span class="n">baselines</span><span class="p">,</span> <span class="n">trace_scale</span><span class="o">=</span><span class="n">trace_scale</span><span class="p">,</span> <span class="n">weight_scale</span><span class="o">=</span><span class="n">weight_scaling</span><span class="p">)</span>

<span class="c1"># Display</span>
<span class="n">plot_scaled_trace</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">bss2_traces</span><span class="p">,</span> <span class="n">mock_trace</span><span class="p">)</span>

<span class="n">hxtorch</span><span class="o">.</span><span class="n">release_hardware</span><span class="p">()</span>
</pre></div>
</div>
<a class="solution reference internal image-reference" href="../_images/hxsnn_intro_trace_scaling.png"><img alt="../_images/hxsnn_intro_trace_scaling.png" class="solution align-center" src="../_images/hxsnn_intro_trace_scaling.png" style="width: 90%;" /></a>
<p>Now that we have aligned the dynamics on hardware and in the numerics, we can use the hardware to emulate out network and use the numerics to compute gradients for a given task.
Training networks on BSS-2 using <code class="docutils literal notranslate"><span class="pre">hxtorch.snn</span></code> works the same as for plain PyTorch.
Its easy… sometimes.</p>
<p>In the remainder of this demo we will train a non-spiking leak-integrator (LI) output neuron to resemble a target trace.
LI neuron layers are created by using <code class="docutils literal notranslate"><span class="pre">ReadoutNeurons</span></code>.</p>
<p>As the target pattern we use a sine:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_target</span><span class="p">(</span><span class="n">n_out</span><span class="p">):</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_out</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">targets</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mf">0.3</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">100</span><span class="p">))</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">targets</span> <span class="o">/</span> <span class="n">norm</span><span class="o">.</span><span class="n">values</span>

<span class="n">targets</span> <span class="o">=</span> <span class="n">get_target</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># Display</span>
<span class="n">plot_targets</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
</pre></div>
</div>
<a class="solution reference internal image-reference" href="../_images/hxsnn_intro_targets.png"><img alt="../_images/hxsnn_intro_targets.png" class="solution align-center" src="../_images/hxsnn_intro_targets.png" style="width: 90%;" /></a>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">w</span>

<span class="n">hxtorch</span><span class="o">.</span><span class="n">init_hardware</span><span class="p">()</span>

<span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">200</span>

<span class="n">exp</span> <span class="o">=</span> <span class="n">hxsnn</span><span class="o">.</span><span class="n">Experiment</span><span class="p">(</span><span class="n">mock</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">exp</span><span class="o">.</span><span class="n">default_execution_instance</span><span class="o">.</span><span class="n">load_calib</span><span class="p">(</span><span class="s2">&quot;spiking_calix-native.pkl&quot;</span><span class="p">)</span>

<span class="n">lin1</span> <span class="o">=</span> <span class="n">hxsnn</span><span class="o">.</span><span class="n">Synapse</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span>
            <span class="n">linear_saturating</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">55</span><span class="p">))</span>
<span class="n">li</span> <span class="o">=</span> <span class="n">hxsnn</span><span class="o">.</span><span class="n">ReadoutNeuron</span><span class="p">(</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="n">exp</span><span class="p">,</span>
    <span class="n">tau_mem</span><span class="o">=</span><span class="mf">10e-6</span><span class="p">,</span>
    <span class="n">tau_syn</span><span class="o">=</span><span class="mf">10e-6</span><span class="p">,</span>
    <span class="n">leak</span><span class="o">=</span><span class="n">hxsnn</span><span class="o">.</span><span class="n">MixedHXModelParameter</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">80.</span><span class="p">),</span>
    <span class="n">shift_cadc_to_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">trace_scale</span><span class="o">=</span><span class="n">trace_scale</span><span class="p">,</span>
    <span class="n">trace_offset</span><span class="o">=</span><span class="n">baselines</span><span class="p">)</span>

<span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">0.03</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">lin1</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">2e-3</span><span class="p">)</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>

<span class="n">update_plot</span> <span class="o">=</span> <span class="n">plot_training</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">EPOCHS</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">):</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

    <span class="c1"># Forward</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">lin1</span><span class="p">(</span><span class="n">hxsnn</span><span class="o">.</span><span class="n">NeuronHandle</span><span class="p">(</span><span class="n">inputs</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">li</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

    <span class="c1"># Run on BSS-2</span>
    <span class="n">hxsnn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="c1"># Optimize</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">membrane_cadc</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="c1"># Plot</span>
    <span class="n">output</span><span class="o">.</span><span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">update_plot</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">y</span><span class="p">)</span>

<span class="n">hxtorch</span><span class="o">.</span><span class="n">release_hardware</span><span class="p">()</span>
</pre></div>
</div>
<a class="solution reference internal image-reference" href="../_images/hxsnn_intro_training.png"><img alt="../_images/hxsnn_intro_training.png" class="solution align-center" src="../_images/hxsnn_intro_training.png" style="width: 90%;" /></a>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ts_11-plasticity_homeostasis.html" class="btn btn-neutral float-left" title="BrainScaleS-2 on-chip plasticity experiment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="ts_13-network_partitioning.html" class="btn btn-neutral float-right" title="Partitioning of Feedforward SNNs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Electronic Vision(s).</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>